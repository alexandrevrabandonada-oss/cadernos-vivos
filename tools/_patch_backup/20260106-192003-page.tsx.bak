import type { CSSProperties } from "react";
import V2Nav from "@/components/v2/V2Nav";
import ProvasV2 from "@/components/v2/ProvasV2";
import { loadCadernoV2 } from "@/lib/v2";
import type { Metadata } from "next";
import { cvReadMetaLoose } from "@/lib/v2/load";
import Cv2DomFilterClient from "@/components/v2/Cv2DomFilterClient";
<Cv2ProvasGroupedClient rootId="cv2-provas-root" listSelector="[data-cv2-provas-list]" />
import { Cv2ProvasGroupedClient } from "@/components/v2/Cv2ProvasGroupedClient";

type AnyParams = { slug: string } | Promise<{ slug: string }>; 
type AnyObj = Record<string, unknown>;

function isObj(v: unknown): v is AnyObj {
  return !!v && typeof v === "object" && !Array.isArray(v);
}

async function getSlug(params: AnyParams): Promise<string> {
  const p = await Promise.resolve(params as unknown as { slug: string });
  return (p && p.slug) ? p.slug : "";
}


export async function generateMetadata({ params }: { params: { slug: string } }): Promise<Metadata> {
  const meta = await cvReadMetaLoose(params.slug);
  const title = (typeof meta.title === "string" && meta.title.trim().length) ? meta.title.trim() : params.slug;
  const m = meta as unknown as Record<string, unknown>;
  const rawDesc = (typeof m["description"] === "string") ? (m["description"] as string) : "";
  const description = rawDesc.trim().length ? rawDesc.trim() : undefined;
  return {
    title: title + " â€¢ Cadernos Vivos",
    description,
  };
}
export default async function Page({ params }: { params: AnyParams }) {
  const slug = await getSlug(params);
  const data = await loadCadernoV2(slug);

  const title = (data && (data as unknown as { title?: string }).title) ? (data as unknown as { title: string }).title : slug;
  const meta = (data && (data as unknown as { meta?: unknown }).meta !== undefined) ? (data as unknown as { meta?: unknown }).meta : null;

  const accent = (isObj(meta) && typeof meta["accent"] === "string") ? String(meta["accent"]) : "#F5C400";
  const bar: CSSProperties = { height: 3, borderRadius: 999, background: accent, opacity: 0.9 };

  return (
    <main style={{ padding: 18, maxWidth: 1100, margin: "0 auto" }}>
      <div style={bar} />
      <V2Nav slug={slug} active={"provas"} />
      <div style={{ marginTop: 12 }}>
                <div id="cv2-provas-root">
          <Cv2DomFilterClient rootId="cv2-provas-root" placeholder="Filtrar provas..." />
          <div data-cv2-provas-list="1">
          <ProvasV2 slug={slug} title={title} />
          </div>
        </div>
      </div>
    </main>
  );
}