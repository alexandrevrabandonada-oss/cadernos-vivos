"use client";

import Link from "next/link";
import { useMemo, useState } from "react";

export type MapLink = { label: string; href: string };

export type MapPoint = {
  id: string;
  title: string;
  category: string;
  summary?: string;
  lat?: number;
  lng?: number;
  x?: number; // 0..100 (para mapa-imagem futuro)
  y?: number; // 0..100 (para mapa-imagem futuro)
  links?: MapLink[];
};

function clamp(n: number, a: number, b: number) {
  return Math.max(a, Math.min(b, n));
}

function osmEmbed(lat: number, lng: number) {
  const d = 0.01;
  const left = lng - d;
  const right = lng + d;
  const top = lat + d;
  const bottom = lat - d;
  const bbox = String(left) + "," + String(bottom) + "," + String(right) + "," + String(top);
  return "https://www.openstreetmap.org/export/embed.html?bbox=" + encodeURIComponent(bbox) + "&layer=mapnik&marker=" + String(lat) + "%2C" + String(lng);
}

function osmLink(lat: number, lng: number) {
  const z = 16;
  return "https://www.openstreetmap.org/?mlat=" + String(lat) + "&mlon=" + String(lng) + "#map=" + String(z) + "/" + String(lat) + "/" + String(lng);
}

export default function TerritoryMap({
  slug,
  points,
}: {
  slug: string;
  points: MapPoint[];
}) {
  const cats = useMemo(() => {
    const s = new Set<string>();
    points.forEach((p) => s.add(p.category || "Geral"));
    return ["Tudo", ...Array.from(s).sort((a, b) => a.localeCompare(b))];
  }, [points]);

  const [cat, setCat] = useState("Tudo");
  const filtered = useMemo(() => {
    if (cat === "Tudo") return points;
    return points.filter((p) => (p.category || "Geral") === cat);
  }, [points, cat]);

  const [selId, setSelId] = useState<string>(() => (points[0]?.id ? points[0].id : ""));
  const selected = useMemo(() => filtered.find((p) => p.id === selId) || filtered[0], [filtered, selId]);

  const hasCoords = !!(selected && typeof selected.lat === "number" && typeof selected.lng === "number");
  const lat = hasCoords ? clamp(selected!.lat as number, -90, 90) : -22.52;
  const lng = hasCoords ? clamp(selected!.lng as number, -180, 180) : -44.10;

  return (
    <section className="grid gap-4 lg:grid-cols-[360px_1fr]">
      <div className="space-y-4">
        <div className="card p-5">
          <h3 className="text-lg font-semibold">Filtros</h3>
          <div className="mt-3 flex flex-wrap gap-2">
            {cats.map((c) => (
              <button
                key={c}
                onClick={() => {
                  setCat(c);
                  setSelId("");
                }}
                className={"card px-3 py-2 transition hover:bg-white/10 " + (cat === c ? "border-white/30" : "")}
              >
                <span className="accent">{c}</span>
              </button>
            ))}
          </div>
          <p className="muted text-sm mt-3">
            Mapa aqui é ferramenta de leitura do território: organizar fatos, conectar pontos,
            e transformar em pedido concreto + ação simples.
          </p>
        </div>

        <div className="card p-5">
          <h3 className="text-lg font-semibold">Pontos</h3>
          {filtered.length === 0 ? (
            <p className="muted mt-2">Sem pontos nessa categoria.</p>
          ) : (
            <div className="mt-3 grid gap-2">
              {filtered.map((p) => (
                <button
                  key={p.id}
                  onClick={() => setSelId(p.id)}
                  className={"text-left card p-3 hover:bg-white/10 transition " + (selected?.id === p.id ? "border-white/30" : "")}
                >
                  <div className="text-xs muted">{p.category}</div>
                  <div className="font-semibold">{p.title}</div>
                  {p.summary ? <div className="muted text-sm mt-1">{p.summary}</div> : null}
                </button>
              ))}
            </div>
          )}

          <div className="mt-4 text-sm muted">
            Edita os pontos em: <code className="muted">content/cadernos/{slug}/mapa.json</code>
          </div>
        </div>
      </div>

      <div className="space-y-4">
        <div className="card p-5">
          <div className="flex flex-wrap items-center justify-between gap-3">
            <div>
              <div className="text-xs muted">{selected?.category || "Geral"}</div>
              <h3 className="text-xl font-semibold">{selected?.title || "Mapa do território"}</h3>
            </div>
            <div className="flex flex-wrap gap-2">
              <Link className="card px-3 py-2 hover:bg-white/10 transition" href={"/c/" + slug}>
                <span className="accent">Voltar ao caderno</span>
              </Link>
              {hasCoords ? (
                <a className="card px-3 py-2 hover:bg-white/10 transition" href={osmLink(lat, lng)} target="_blank" rel="noreferrer">
                  <span className="accent">Abrir no OSM</span>
                </a>
              ) : null}
            </div>
          </div>

          {selected?.summary ? <p className="muted mt-3">{selected.summary}</p> : null}

          {selected?.links && selected.links.length ? (
            <div className="mt-4 flex flex-wrap gap-2">
              {selected.links.map((l) => (
                <a key={l.href} className="card px-3 py-2 hover:bg-white/10 transition" href={l.href} target="_blank" rel="noreferrer">
                  <span className="accent">{l.label}</span>
                </a>
              ))}
            </div>
          ) : null}
        </div>

        <div className="card p-2 overflow-hidden">
          <div className="muted text-sm px-4 pt-3">
            {hasCoords ? "Mapa (OSM embed) do ponto selecionado" : "Sem coordenadas nesse ponto (adicione lat/lng no mapa.json)"}
          </div>
          <div className="mt-3 aspect-[16/10] w-full">
            <iframe
              title="Mapa"
              className="h-full w-full border-0 opacity-95"
              src={osmEmbed(lat, lng)}
              loading="lazy"
            />
          </div>
        </div>

        <div className="card p-5">
          <h3 className="text-lg font-semibold">Fechamento</h3>
          <p className="muted mt-2">
            1) O que esse ponto prova/indica (sem pânico). 2) O que ele conecta (cadeia).
            3) Qual pedido concreto nasce daqui. 4) Qual ação simples de ajuda mútua dá pra fazer hoje.
          </p>
        </div>
      </div>
    </section>
  );
}
