"use client";

import Link from "next/link";
import { useEffect, useMemo, useState } from "react";

function keyFor(slug: string) {
  return `cv:${slug}:aulasDone:v1`;
}

function parseSet(raw: string | null): Set<number> {
  try {
    if (!raw) return new Set();
    const arr = JSON.parse(raw) as number[];
    return new Set(Array.isArray(arr) ? arr : []);
  } catch {
    return new Set();
  }
}

function saveSet(k: string, s: Set<number>) {
  try { localStorage.setItem(k, JSON.stringify(Array.from(s.values()).sort((a,b)=>a-b))); } catch {}
}

export default function AulaProgress({ slug, total, current }: { slug: string; total: number; current: number }) {
  const k = useMemo(() => keyFor(slug), [slug]);
  const [done, setDone] = useState<Set<number>>(new Set());

  useEffect(() => {
    setDone(parseSet(localStorage.getItem(k)));
  }, [k]);

  const isDone = done.has(current);
  const toggle = () => {
    const next = new Set(done);
    if (next.has(current)) next.delete(current); else next.add(current);
    setDone(next);
    saveSet(k, next);
  };

  return (
    <div className="card p-4">
      <div className="flex items-center justify-between gap-3">
        <div className="text-sm muted">Progresso das aulas</div>
        <button className="card px-3 py-2 hover:bg-white/10 transition" onClick={toggle}>
          <span className="accent">{isDone ? "Marcar como n√£o-feita" : "Marcar como feita"}</span>
        </button>
      </div>

      <div className="mt-3 flex flex-wrap gap-2">
        {Array.from({ length: total }).map((_, i) => {
          const n = i + 1;
          const d = done.has(n);
          const href = `/c/${slug}/a/${n}`;
          const base = "w-9 h-9 rounded-xl border flex items-center justify-center text-sm transition";
          const cls = d
            ? (base + " border-[color:var(--accent)] bg-white/10")
            : (base + " border-white/10 hover:bg-white/10");
          const cur = n === current;
          return (
            <Link key={n} href={href} className={cls} aria-label={`Aula ${n}`}>
              <span className={cur ? "accent font-semibold" : (d ? "accent" : "")}>{n}</span>
            </Link>
          );
        })}
      </div>
    </div>
  );
}