"use client";

import { useEffect, useRef, useState } from "react";
function foldText(input: unknown): string {
  const raw = (input == null ? "" : String(input));
  const lower = raw.toLowerCase();
  // remove acentos sem regex unicode (parser-safe)
  try {
    const n = lower.normalize("NFD");
    let out = "";
    for (let i = 0; i < n.length; i += 1) {
      const c = n.charCodeAt(i);
      if (c < 0x0300 || c > 0x036f) out += n[i];
    }
    return out;
  } catch {
    return lower;
  }
}
function collectItems(root: HTMLElement): HTMLElement[] {
  const selectors = [".cv2-card", "[data-cv2-card]", "article", "li"];
  const skip = '[data-cv2-filter-ui="1"]';
  for (const sel of selectors) {
    const nodes = Array.from(root.querySelectorAll(sel));
    const items = nodes.filter((n) => n instanceof HTMLElement);
    const filtered = items.filter((el) => !el.closest(skip));
    if (filtered.length > 0) return filtered;
  }
  return [];
}
export function Cv2DomFilterClient(props: { rootId: string; placeholder?: string }) {
  const rootId = props && props.rootId ? String(props.rootId) : "";
  const placeholder = props && props.placeholder ? String(props.placeholder) : "buscar...";

  const [query, setQuery] = useState("");
  const [stats, setStats] = useState({ total: 0, shown: 0 });
  const itemsRef = useRef<HTMLElement[]>([]);

  useEffect(() => {
    const root = rootId ? document.getElementById(rootId) : null;
    if (!root) {
      itemsRef.current = [];
      setStats({ total: 0, shown: 0 });
      return;
    }
    const items = collectItems(root);
    itemsRef.current = items;
    setStats({ total: items.length, shown: items.length });
  }, [rootId]);

  useEffect(() => {
    const items = itemsRef.current;
    if (!items || items.length === 0) {
      setStats({ total: 0, shown: 0 });
      return;
    }
    const q = foldText(query.trim());
    let shown = 0;
    for (const el of items) {
      const hay = foldText(el.textContent || "");
      const ok = q.length === 0 ? true : hay.includes(q);
      // eslint-disable-next-line react-hooks/immutability
      el.hidden = !ok;
      if (ok) shown += 1;
    }
    setStats({ total: items.length, shown });
  }, [query]);

  const canClear = query.trim().length > 0;

  return (
    <div
      data-cv2-filter-ui="1"
      style={{ display: "flex", gap: 10, alignItems: "center", flexWrap: "wrap", margin: "10px 0 14px" }}
    >
      <label style={{ display: "flex", alignItems: "center", gap: 8 }}>
        <span className="cv2-muted" style={{ fontSize: 12 }}>filtrar</span>
        <input
          type="search"
          value={query}
          onChange={(e) => setQuery(e.target.value)}
          onKeyDown={(e) => { if (e.key === "Escape") setQuery(""); }}
          placeholder={placeholder}
          style={{
            padding: "10px 12px",
            borderRadius: 12,
            border: "1px solid var(--cv2-line, rgba(255,255,255,.10))",
            background: "rgba(0,0,0,.22)",
            color: "inherit",
            outline: "none",
            minWidth: 220,
          }}
        />
      </label>

      {canClear ? (
        <button type="button" onClick={() => setQuery("")} className="cv2-chip" style={{ cursor: "pointer" }}>
          limpar
        </button>
      ) : null}

      <span className="cv2-muted" style={{ fontSize: 12 }}>{stats.shown}/{stats.total}</span>
    </div>
  );
}