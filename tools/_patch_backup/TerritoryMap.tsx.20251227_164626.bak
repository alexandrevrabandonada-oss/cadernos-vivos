"use client";

import { useEffect, useMemo, useState, type ChangeEvent } from "react";
import Link from "next/link";
import { useParams } from "next/navigation";

export type MapPoint = {
  id: string;
  title: string;
  label?: string;
  name?: string;
  kind?: string;
  lat?: number;
  lng?: number;
  note?: string;
};

function slugFromParams(p: unknown): string | undefined {
  if (!p || typeof p !== "object") return;
  const v = (p as Record<string, unknown>).slug;
  return typeof v === "string" ? v : undefined;
}

function keyFor(slug: string) {
  return `cv:${slug}:map:v1`;
}

function safeGet(k: string): string | null {
  try {
    if (typeof window === "undefined") return null;
    return window.localStorage.getItem(k);
  } catch {
    return null;
  }
}

function safeSet(k: string, v: string) {
  try {
    if (typeof window === "undefined") return;
    window.localStorage.setItem(k, v);
  } catch {}
}

type Visited = Record<string, boolean>;

function loadVisited(slug: string): Visited {
  try {
    const raw = safeGet(keyFor(slug));
    if (!raw) return {};
    const data = JSON.parse(raw) as unknown;
    if (!data || typeof data !== "object") return {};
    return data as Visited;
  } catch {
    return {};
  }
}

export default function TerritoryMap({
  slug,
  points,
}: {
  slug?: string;
  points: MapPoint[];
}) {
  const params = useParams();
  const s = slug ?? slugFromParams(params);

  const [q, setQ] = useState("");
  const [selected, setSelected] = useState<MapPoint | null>(null);
  const [visited, setVisited] = useState<Visited>(() => (s ? loadVisited(s) : {}));

  useEffect(() => {
    if (!s) return;
    safeSet(keyFor(s), JSON.stringify(visited));
  }, [s, visited]);

  const list = useMemo(() => {
    const term = q.trim().toLowerCase();
    if (!term) return points;
    return points.filter((p) => {
      const a = (p.title || "").toLowerCase();
      const b = (p.kind || "").toLowerCase();
      const c = (p.note || "").toLowerCase();
      return a.includes(term) || b.includes(term) || c.includes(term);
    });
  }, [q, points]);

  const onSearch = (e: ChangeEvent<HTMLInputElement>) => setQ(e.target.value);

  const openMaps = (p: MapPoint) => {
    if (!p.lat || !p.lng) return;
    const href = `https://www.google.com/maps?q=${p.lat},${p.lng}`;
    window.open(href, "_blank", "noopener,noreferrer");
  };

  return (
    <div className="space-y-4">
      <div className="card p-5">
        <div className="flex flex-wrap items-end justify-between gap-3">
          <div>
            <div className="text-xs muted">Mapa do território</div>
            <div className="text-lg font-semibold mt-1">Pontos e lugares citados</div>
            <div className="text-sm muted mt-1">Não é mapa “bonitinho”: é ferramenta de leitura do chão.</div>
          </div>
          <div className="w-full sm:w-72">
            <input
              className="w-full rounded-xl border border-white/10 bg-black/20 p-3 outline-none focus:border-white/20"
              placeholder="Buscar ponto, tipo, nota..."
              value={q}
              onChange={onSearch}
            />
          </div>
        </div>
      </div>

      <div className="grid gap-3">
        {list.map((p) => (
          <button
            key={p.id}
            onClick={() => {
              setSelected(p);
              setVisited((v) => ({ ...v, [p.id]: true }));
            }}
            className="card p-5 text-left hover:bg-white/10 transition"
          >
            <div className="flex items-start justify-between gap-3">
              <div>
                <div className="text-xs muted">{p.kind || "ponto"}</div>
                <div className="text-lg font-semibold mt-1">{p.title}</div>
                {p.note ? <div className="muted mt-2">{p.note}</div> : null}
              </div>
              <div className="text-xs muted">{visited[p.id] ? "visto" : ""}</div>
            </div>
          </button>
        ))}
      </div>

      {selected ? (
        <div className="card p-5">
          <div className="text-xs muted">{selected.kind || "ponto"}</div>
          <div className="text-xl font-semibold mt-1">{selected.title}</div>
          {selected.note ? <div className="muted mt-2">{selected.note}</div> : null}

          <div className="mt-4 flex flex-wrap gap-2">
            {selected.lat && selected.lng ? (
              <button className="card px-3 py-2 hover:bg-white/10 transition" onClick={() => openMaps(selected)}>
                <span className="accent">Abrir no Maps</span>
              </button>
            ) : null}
            {s ? (
              <Link className="card px-3 py-2 hover:bg-white/10 transition" href={`/c/${s}/debate`}>
                Ir pro debate
              </Link>
            ) : null}
            <button className="card px-3 py-2 hover:bg-white/10 transition" onClick={() => setSelected(null)}>
              Fechar
            </button>
          </div>
        </div>
      ) : null}
    </div>
  );
}