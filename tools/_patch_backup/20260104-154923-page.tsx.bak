import { notFound } from "next/navigation";
import type { CSSProperties } from "react";
import { readFile } from "node:fs/promises";
import { join } from "node:path";
import { getCaderno } from "@/lib/cadernos";
import V2Nav from "@/components/v2/V2Nav";
import { TrilhasV2, type Trail, type TrailStep } from "@/components/v2/TrilhasV2";

type AccentStyle = CSSProperties & Record<"--accent", string>;
type AnyObj = Record<string, unknown>;

function isObj(v: unknown): v is AnyObj {
  return !!v && typeof v === "object" && !Array.isArray(v);
}

function asStr(v: unknown): string {
  return typeof v === "string" ? v : "";
}

function trailFromUnknown(v: unknown, idx: number): Trail | null {
  if (!isObj(v)) return null;
  const id = asStr(v["id"]) || ("trilha-" + String(idx + 1));
  const title = asStr(v["title"]) || id;
  const summary = asStr(v["summary"]) || asStr(v["desc"]) || "";
  const rawSteps = v["steps"];
  const steps: TrailStep[] = Array.isArray(rawSteps)
    ? rawSteps.map((s, j) => {
        if (!isObj(s)) return { id: "etapa-" + String(j + 1), title: "Etapa " + String(j + 1) };
        return {
          id: asStr(s["id"]) || ("etapa-" + String(j + 1)),
          title: asStr(s["title"]) || asStr(s["label"]) || ("Etapa " + String(j + 1)),
          href: asStr(s["href"]) || asStr(s["url"]) || "",
          kind: asStr(s["kind"]) || asStr(s["type"]) || "",
        };
      })
    : [];
  return { id, title, summary: summary || undefined, steps: steps.length ? steps : undefined };
}

function trailsFromMapa(mapa: unknown): Trail[] {
  if (!mapa) return [];
  const nodes: unknown[] = Array.isArray(mapa)
    ? mapa
    : isObj(mapa) && Array.isArray(mapa["nodes"])
      ? (mapa["nodes"] as unknown[])
      : isObj(mapa) && Array.isArray(mapa["items"])
        ? (mapa["items"] as unknown[])
        : [];

  const out: Trail[] = [];
  for (let i = 0; i < nodes.length; i++) {
    const n = nodes[i];
    if (!isObj(n)) continue;
    const t = asStr(n["type"]) || asStr(n["kind"]);
    if (t !== "trail") continue;
    const id = asStr(n["id"]) || ("trail-" + String(i + 1));
    const title = asStr(n["title"]) || asStr(n["label"]) || id;
    const summary = asStr(n["summary"]) || asStr(n["desc"]) || "";
    const rawSteps = n["steps"];
    const steps: TrailStep[] = Array.isArray(rawSteps)
      ? rawSteps.map((s, j) => {
          if (!isObj(s)) return { id: "etapa-" + String(j + 1), title: "Etapa " + String(j + 1) };
          return {
            id: asStr(s["id"]) || ("etapa-" + String(j + 1)),
            title: asStr(s["title"]) || asStr(s["label"]) || ("Etapa " + String(j + 1)),
            href: asStr(s["href"]) || asStr(s["url"]) || "",
            kind: asStr(s["kind"]) || asStr(s["type"]) || "",
          };
        })
      : [];
    out.push({ id, title, summary: summary || undefined, steps: steps.length ? steps : undefined });
  }
  return out;
}

async function loadTrilhasJson(slug: string): Promise<unknown | null> {
  try {
    const p = join(process.cwd(), "content", "cadernos", slug, "trilhas.json");
    const raw = await readFile(p, "utf8");
    return JSON.parse(raw) as unknown;
  } catch {
    return null;
  }
}

function trailsFromJson(v: unknown): Trail[] {
  const arr: unknown[] = Array.isArray(v)
    ? v
    : isObj(v) && Array.isArray(v["trilhas"])
      ? (v["trilhas"] as unknown[])
      : [];

  const out: Trail[] = [];
  for (let i = 0; i < arr.length; i++) {
    const t = trailFromUnknown(arr[i], i);
    if (t && t.id && t.title) out.push(t);
  }
  return out;
}

export default async function Page({ params }: { params: Promise<{ slug: string }> }) {
  const { slug } = await params;

  let data: Awaited<ReturnType<typeof getCaderno>>;
  try {
    data = await getCaderno(slug);
  } catch (e) {
    const err = e as { code?: string };
    if (err && err.code === "ENOENT") return notFound();
    throw e;
  }

  const title = data.meta?.title ?? slug;
  const accent = data.meta?.accent ?? "#F7C600";
  const s: AccentStyle = { ["--accent"]: accent } as AccentStyle;

  const json = await loadTrilhasJson(slug);
  const fromJson = trailsFromJson(json);
  const fromMapa = trailsFromMapa((data as unknown as AnyObj)["mapa"]);
  const trails = fromJson.length ? fromJson : fromMapa;

  return (
    <main style={{ padding: 14, maxWidth: 1100, margin: "0 auto", ...s }}>
      <V2Nav slug={slug} active="trilhas" />
      <div style={{ marginTop: 12 }}>
        <TrilhasV2 slug={slug} title={title} trails={trails} />
      </div>
    </main>
  );
}