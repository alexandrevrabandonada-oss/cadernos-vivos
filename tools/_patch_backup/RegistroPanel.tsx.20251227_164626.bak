"use client";

import { useMemo, useState } from "react";
import { useParams } from "next/navigation";

type DebateSaved = {
  answers: Record<string, string>;
  pedidoConcreto: string;
  acaoAjudaMutua: string;
};

type ProgressSaved = { total: number; current: number; updatedAt: number };

function slugFromParams(p: unknown): string | undefined {
  if (!p || typeof p !== "object") return;
  const v = (p as Record<string, unknown>).slug;
  return typeof v === "string" ? v : undefined;
}

function kDebate(slug: string) { return `cv:${slug}:debate:v1`; }
function kProg1(slug: string) { return `cv:${slug}:aulaProgress:v1`; }
function kProgAlt(slug: string) { return `cv:${slug}:progress:v1`; }

function safeGet(k: string): string | null {
  try {
    if (typeof window === "undefined") return null;
    return window.localStorage.getItem(k);
  } catch {
    return null;
  }
}

function safeRemove(k: string) {
  try {
    if (typeof window === "undefined") return;
    window.localStorage.removeItem(k);
  } catch {}
}

function loadDebate(slug: string): DebateSaved | null {
  try {
    const raw = safeGet(kDebate(slug));
    if (!raw) return null;
    const data = JSON.parse(raw) as Partial<DebateSaved>;
    return {
      answers: (data.answers as Record<string, string>) || {},
      pedidoConcreto: (data.pedidoConcreto as string) || "",
      acaoAjudaMutua: (data.acaoAjudaMutua as string) || "",
    };
  } catch {
    return null;
  }
}

function loadProg(slug: string): ProgressSaved | null {
  const keys = [kProg1(slug), kProgAlt(slug)];
  for (const k of keys) {
    const raw = safeGet(k);
    if (!raw) continue;
    try {
      const data = JSON.parse(raw) as Partial<ProgressSaved>;
      if (typeof data.total === "number" && typeof data.current === "number") {
        return {
          total: data.total,
          current: data.current,
          updatedAt: typeof data.updatedAt === "number" ? data.updatedAt : Date.now(),
        };
      }
    } catch {}
  }
  return null;
}

export default function RegistroPanel({ slug }: { slug?: string }) {
  const params = useParams();
  const s = useMemo(() => slug ?? slugFromParams(params) ?? "", [slug, params]);

  const debate = useMemo(() => (s ? loadDebate(s) : null), [s]);
  const prog = useMemo(() => (s ? loadProg(s) : null), [s]);
  const [status, setStatus] = useState<"" | "copiado">("");

  const copy = async () => {
    if (!s) return;
    try {
      const payload = {
        slug: s,
        generatedAt: new Date().toISOString(),
        progress: prog,
        debate: debate,
      };
      await navigator.clipboard.writeText(JSON.stringify(payload, null, 2));
      setStatus("copiado");
      setTimeout(() => setStatus(""), 1200);
    } catch {}
  };

  const clear = () => {
    if (!s) return;
    safeRemove(kDebate(s));
    safeRemove(kProg1(s));
    safeRemove(kProgAlt(s));
    window.location.reload();
  };

  const answered = debate ? Object.values(debate.answers || {}).filter((v) => (v || "").trim().length > 0).length : 0;

  if (!s) {
    return (
      <div className="card p-5">
        <div className="text-lg font-semibold">Carregando…</div>
        <div className="muted mt-2">Aguardando slug do caderno.</div>
      </div>
    );
  }

  return (
    <div className="space-y-4">
      <div className="card p-5">
        <h2 className="text-xl font-semibold">Registro do Caderno</h2>
        <p className="muted mt-2">
          Isso é o “Registro do Caderno” (progresso + debate) salvo no seu aparelho. Não é “recibo de mutirão” (isso é do app ECO).
        </p>
      </div>

      <div className="card p-5">
        <div className="text-xs muted">Progresso</div>
        {prog ? (
          <div className="mt-2">
            <div className="text-lg font-semibold">{prog.current} / {prog.total} aulas</div>
            <div className="text-sm muted mt-1">Atualizado: {new Date(prog.updatedAt).toLocaleString()}</div>
          </div>
        ) : (
          <div className="muted mt-2">Sem progresso salvo ainda (abra uma aula pra marcar).</div>
        )}
      </div>

      <div className="card p-5">
        <div className="text-xs muted">Debate</div>
        {debate ? (
          <div className="mt-2 space-y-2">
            <div className="text-sm muted">Respostas preenchidas: <span className="accent">{answered}</span></div>
            <div className="text-sm muted">Pedido concreto: <span className="accent">{debate.pedidoConcreto ? "ok" : "vazio"}</span></div>
            <div className="text-sm muted">Ajuda mútua: <span className="accent">{debate.acaoAjudaMutua ? "ok" : "vazio"}</span></div>
          </div>
        ) : (
          <div className="muted mt-2">Sem debate salvo ainda (vá em Debate e salve).</div>
        )}
      </div>

      <div className="card p-5">
        <div className="flex flex-wrap gap-2">
          <button className="card px-3 py-2 hover:bg-white/10 transition" onClick={copy}>
            <span className="accent">{status === "copiado" ? "Copiado!" : "Copiar JSON do registro"}</span>
          </button>
          <button className="card px-3 py-2 hover:bg-white/10 transition" onClick={clear}>
            Limpar registro local
          </button>
        </div>
      </div>
    </div>
  );
}