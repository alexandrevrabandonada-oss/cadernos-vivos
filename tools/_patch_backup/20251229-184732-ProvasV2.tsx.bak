import type { JsonValue } from "@/lib/v2/types";

function asObj(v: unknown): Record<string, JsonValue> | null {
  if (!v || typeof v !== "object") return null;
  return v as Record<string, JsonValue>;
}
function asArr(v: JsonValue | undefined): JsonValue[] {
  return Array.isArray(v) ? v : [];
}
function asStr(v: JsonValue | undefined): string | null {
  return typeof v === "string" ? v : null;
}

type Props = { slug: string; title: string; acervo: unknown };

export default function ProvasV2({ slug, title, acervo }: Props) {
  const o = asObj(acervo);
  const items = asArr(o ? (o["items"] as JsonValue) : undefined);

  return (
    <div style={{ border: "1px solid rgba(255,255,255,0.10)", borderRadius: 12, padding: 14 }}>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "baseline", gap: 12 }}>
        <div>
          <div style={{ fontSize: 12, opacity: 0.7 }}>Provas V2</div>
          <h2 style={{ fontSize: 18, margin: "4px 0 0 0" }}>{title}</h2>
        </div>
        <div style={{ fontSize: 12, opacity: 0.7 }}>slug: {slug}</div>
      </div>

      <div style={{ marginTop: 12, display: "grid", gap: 10 }}>
        {items.length === 0 ? (
          <div style={{ opacity: 0.75, fontSize: 14 }}>
            Nenhum item no acervo (acervo.json).
          </div>
        ) : (
          items.map((it, i) => {
            const io = asObj(it);
            const id = asStr(io ? io["id"] : undefined) || String(i + 1);
            const t = asStr(io ? io["title"] : undefined) || "Item";
            const url = asStr(io ? (io["url"] as JsonValue) : undefined) || asStr(io ? (io["link"] as JsonValue) : undefined);
            const kind = asStr(io ? (io["kind"] as JsonValue) : undefined) || asStr(io ? (io["type"] as JsonValue) : undefined);
            const tags = asArr(io ? (io["tags"] as JsonValue) : undefined).filter((x) => typeof x === "string") as string[];
            return (
              <div key={id} style={{ border: "1px solid rgba(255,255,255,0.08)", borderRadius: 10, padding: 12 }}>
                <div style={{ display: "flex", justifyContent: "space-between", gap: 10, alignItems: "baseline" }}>
                  <div style={{ fontWeight: 700 }}>{t}</div>
                  <div style={{ fontSize: 12, opacity: 0.7 }}>{kind ? kind : "prova"}</div>
                </div>
                {url ? (
                  <div style={{ marginTop: 6 }}>
                    <a href={url} target="_blank" rel="noreferrer" style={{ opacity: 0.9, textDecoration: "underline" }}>
                      Abrir fonte
                    </a>
                  </div>
                ) : null}
                {tags.length ? (
                  <div style={{ marginTop: 8, display: "flex", flexWrap: "wrap", gap: 6 }}>
                    {tags.map((tg) => (
                      <span key={tg} style={{ fontSize: 12, opacity: 0.8, border: "1px solid rgba(255,255,255,0.10)", padding: "2px 8px", borderRadius: 999 }}>
                        {tg}
                      </span>
                    ))}
                  </div>
                ) : null}
              </div>
            );
          })
        )}
      </div>
    </div>
  );
}
