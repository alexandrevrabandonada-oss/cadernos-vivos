import Link from "next/link";
import type { JsonValue } from "@/lib/v2/types";

type Counts = {
  nodes?: number;
  edges?: number;
  provas?: number;
  threads?: number;
  trilhas?: number;
};

type Props = {
  slug: string;
  title: string;
  panorama: JsonValue | null;
  counts?: Counts;
};

function isObj(v: unknown): v is Record<string, unknown> {
  return !!v && typeof v === "object" && !Array.isArray(v);
}

function asObj(v: JsonValue | null): Record<string, JsonValue> | null {
  if (!v || typeof v !== "object" || Array.isArray(v)) return null;
  return v as Record<string, JsonValue>;
}

function asArr(v: JsonValue | null): JsonValue[] | null {
  return Array.isArray(v) ? (v as JsonValue[]) : null;
}

function pickFirstString(v: JsonValue | null): string {
  if (typeof v === "string") return v;
  const o = asObj(v);
  if (o) {
    for (const k of ["resumo", "descricao", "descrição", "subtitle", "subtitulo", "subtítulo", "pitch"]) {
      const x = o[k];
      if (typeof x === "string" && x.trim().length > 0) return x;
    }
  }
  return "";
}

function pickFios(panorama: JsonValue | null): string[] {
  const o = asObj(panorama);
  if (!o) return [];
  const keys = ["fiosQuentes", "fios", "hot", "destaques", "tags"];
  for (const k of keys) {
    const v = o[k] ?? null;
    const a = asArr(v);
    if (a) {
      const s = a.filter((x) => typeof x === "string").map((x) => String(x).trim()).filter(Boolean);
      if (s.length > 0) return s;
    }
    if (isObj(v)) {
      const obj = v as Record<string, unknown>;
      const items = obj["items"];
      if (Array.isArray(items)) {
        const s = items.filter((x) => typeof x === "string").map((x) => String(x).trim()).filter(Boolean);
        if (s.length > 0) return s;
      }
    }
  }
  return [];
}

function fmt(n?: number): string {
  return typeof n === "number" ? String(n) : "—";
}

export default function HomeV2(props: Props) {
  const slug = props.slug;
  const title = props.title;
  const panorama = props.panorama;
  const counts = props.counts || {};

  const base = "/c/" + slug + "/v2";
  const subtitle = pickFirstString(panorama);
  const fios = pickFios(panorama).slice(0, 6);

  return (
    <section style={{ display: "flex", flexDirection: "column", gap: 12 }}>
      <header style={{ display: "flex", flexDirection: "column", gap: 6 }}>
        <div style={{ fontSize: 12, opacity: 0.75 }}>Concreto Zen • UI V2</div>
        <h1 style={{ margin: 0, fontSize: 26, letterSpacing: 0.2 }}>{title}</h1>
        {subtitle ? (
          <p style={{ margin: 0, opacity: 0.85, lineHeight: 1.5 }}>{subtitle}</p>
        ) : null}
      </header>

      <div style={{
        display: "grid",
        gridTemplateColumns: "repeat(auto-fit, minmax(220px, 1fr))",
        gap: 12
      }}>
        <Link href={base + "/mapa"} style={{
          textDecoration: "none",
          color: "inherit",
          border: "1px solid rgba(255,255,255,0.10)",
          borderRadius: 14,
          padding: 14,
          background: "rgba(0,0,0,0.35)"
        }}>
          <div style={{ fontSize: 12, opacity: 0.75 }}>Porta 1</div>
          <div style={{ fontSize: 18, marginTop: 4 }}>Mapa</div>
          <div style={{ marginTop: 8, opacity: 0.85, lineHeight: 1.45 }}>
            Território vivo: nós, conexões e camadas.
          </div>
          <div style={{ marginTop: 10, display: "flex", gap: 10, opacity: 0.75, fontSize: 12 }}>
            <span>nós: {fmt(counts.nodes)}</span>
            <span>ligações: {fmt(counts.edges)}</span>
          </div>
        </Link>

        <Link href={base + "/debate"} style={{
          textDecoration: "none",
          color: "inherit",
          border: "1px solid rgba(255,255,255,0.10)",
          borderRadius: 14,
          padding: 14,
          background: "rgba(0,0,0,0.35)"
        }}>
          <div style={{ fontSize: 12, opacity: 0.75 }}>Porta 2</div>
          <div style={{ fontSize: 18, marginTop: 4 }}>Debate</div>
          <div style={{ marginTop: 8, opacity: 0.85, lineHeight: 1.45 }}>
            Conversas em camadas: tese, perguntas e fricções.
          </div>
          <div style={{ marginTop: 10, display: "flex", gap: 10, opacity: 0.75, fontSize: 12 }}>
            <span>tópicos: {fmt(counts.threads)}</span>
          </div>
        </Link>

        <Link href={base + "/provas"} style={{
          textDecoration: "none",
          color: "inherit",
          border: "1px solid rgba(255,255,255,0.10)",
          borderRadius: 14,
          padding: 14,
          background: "rgba(0,0,0,0.35)"
        }}>
          <div style={{ fontSize: 12, opacity: 0.75 }}>Porta 3</div>
          <div style={{ fontSize: 18, marginTop: 4 }}>Provas</div>
          <div style={{ marginTop: 8, opacity: 0.85, lineHeight: 1.45 }}>
            Acervo e evidências: documentos, links, trechos e prints.
          </div>
          <div style={{ marginTop: 10, display: "flex", gap: 10, opacity: 0.75, fontSize: 12 }}>
            <span>itens: {fmt(counts.provas)}</span>
          </div>
        </Link>
      </div>

      <div style={{ display: "flex", gap: 10, flexWrap: "wrap", opacity: 0.9 }}>
        <Link href={base + "/trilhas"} style={{ textDecoration: "underline", color: "inherit" }}>Trilhas</Link>
        <Link href={base + "/linha-do-tempo"} style={{ textDecoration: "underline", color: "inherit" }}>Linha do tempo</Link>
      </div>

      {fios.length > 0 ? (
        <div style={{
          border: "1px solid rgba(255,255,255,0.10)",
          borderRadius: 14,
          padding: 14,
          background: "rgba(0,0,0,0.25)"
        }}>
          <div style={{ fontSize: 12, opacity: 0.75, marginBottom: 8 }}>Fios quentes</div>
          <ul style={{ margin: 0, paddingLeft: 18, lineHeight: 1.6 }}>
            {fios.map((t) => <li key={t}>{t}</li>)}
          </ul>
        </div>
      ) : null}
    </section>
  );
}